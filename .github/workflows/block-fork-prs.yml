name: Block non-conforming PRs (auto-close + label)
on:
  pull_request_target:
    types: [opened, reopened, edited, synchronize, ready_for_review]

permissions:
  issues: write
  pull-requests: write

env:
  TARGET_BRANCH: main         # branch PRs must target
  BLOCK_FORKS: "true"         # "true" to block PRs from forks
  CLOSE_PR: "true"            # "true" to auto-close non-conforming PRs
  LABEL_NAME: "blocked/pr-policy"  # label to apply to blocked PRs

jobs:
  enforce-pr-policy:
    runs-on: ubuntu-latest
    steps:
      - name: Enforce PR target and block forks (no checkout)
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const target = process.env.TARGET_BRANCH || 'main';
            const blockForks = (process.env.BLOCK_FORKS || 'true') === 'true';
            const closePr = (process.env.CLOSE_PR || 'true') === 'true';
            const labelName = process.env.LABEL_NAME || 'blocked/pr-policy';

            const payload = context.payload;
            if (!payload.pull_request) {
              core.info('No pull_request in payload — nothing to do.');
              return;
            }

            const pr = payload.pull_request;
            const prNumber = pr.number;
            const baseRef = pr.base.ref;
            const headRepo = pr.head && pr.head.repo;
            const baseRepoFull = `${context.repo.owner}/${context.repo.repo}`;
            const headRepoFull = headRepo ? headRepo.full_name : null;
            // Consider it a fork if the head repo is different from the base repo OR the head repo has `fork: true`.
            const isFork = !!(headRepo && (headRepo.fork || headRepoFull !== baseRepoFull));

            const reasons = [];
            if (baseRef !== target) reasons.push(`targets '${baseRef}' (expected '${target}')`);
            if (blockForks && isFork) reasons.push('is opened from a fork (forked repository PRs are not allowed)');

            if (reasons.length === 0) {
              core.info(`PR #${prNumber} meets policy (targets '${target}', in-repo).`);
              return;
            }

            // Ensure label exists; create if missing
            try {
              await github.rest.issues.getLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: labelName
              });
            } catch (err) {
              if (err.status === 404) {
                core.info(`Label '${labelName}' not found — creating it.`);
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: labelName,
                  color: 'b60205',
                  description: 'PR blocked by repository policy (wrong target or from fork)'
                });
              } else {
                throw err;
              }
            }

            const commentBody = `Hi! This repository requires pull requests to:
- target the \`${target}\` branch, and
- be opened from branches inside this repository (no forks).

This PR ${reasons.join(' and ')}.

I have applied the \`${labelName}\` label and ${closePr ? 'closed the PR' : 'left it open'}.

If you believe this is a mistake, please open a new PR that targets the \`${target}\` branch and is created from a branch in this repository.`;
            // Post a comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: commentBody
            });

            // Add label to the PR (issues API treats PRs as issues)
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: [labelName]
            });

            // Optionally close the PR
            if (closePr) {
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                state: 'closed'
              });
            }

            core.setFailed(`PR #${prNumber} blocked because it ${reasons.join(' and ')}.`);
