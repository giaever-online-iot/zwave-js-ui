name: PR Build Snap

on:
  pull_request:
    branches:
      - main
  workflow_run:
    branches:
      - main
    workflows: 
      - "Block non-conforming PRs (auto-close + label)"
    types:
      - completed
  workflow_dispatch:  # Add this for manual testing

permissions:
  contents: read
  actions: read
  pull-requests: read

jobs:
  build:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: read
    outputs:
      platforms: ${{ steps.build.outputs.platforms }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Extract platforms from snapcraft.yaml
        id: extract
        run: |
          # Output a compact JSON array of platform keys, e.g. ["amd64","arm64"]
          # echo "platforms=$(yq '.platforms | keys' -oj -I0 snap/snapcraft.yaml)" >> $GITHUB_OUTPUT
          echo "platforms=$(echo "['amd64']" | yq '.' -oj -I0)" >> $GITHUB_OUTPUT

      - name: Build for ${{ steps.extract.outputs.platforms }}
        id: build
        run: |
          set -xuo pipefail

          # Read platforms JSON array from previous step
          # Convert array to mapping: {"amd64": {}, "arm64": {}}
          platforms_map="$(echo "${{ steps.extract.outputs.platforms}}" | yq 'to_entries | map({"key": .value, "value": {}}) | from_entries' -oj -I0)"

          sudo snap install snapcraft --classic
          export SNAPCRAFT_STORE_CREDENTIALS="${{ secrets.SNAPCRAFT_STORE_CREDENTIALS }}"
          snapcraft whoami || true
          mkdir -p ~/.local/share/snapcraft
          echo "${{ secrets.LAUNCHPAD_CREDENTIALS }}" > ~/.local/share/snapcraft/launchpad-credentials

          # Build for comma-separated list of arches
          snapcraft remote-build -v --launchpad-accept-public-upload \
            --build-for=$(jq -r 'keys | join(",")' <<< "$platforms_map")

          # Collect artifacts per arch
          for p in $(jq -r 'keys[]' <<< "$platforms_map"); do
            sfn=$(ls -d "${PWD}"/zwave-js-ui*_"${p}".snap 2>/dev/null || true)
            lfn=$(ls -d "${PWD}"/snapcraft-*_"${p}"_*.txt 2>/dev/null || true)

            if [[ -n "$sfn" ]]; then
              platforms_map=$(jq --arg p "$p" --arg sfn "$sfn" '.[$p].sfn = $sfn' <<< "$platforms_map")
            else
              platforms_map=$(jq --arg p "$p" '.[$p].sfn = ""' <<< "$platforms_map")
            fi

            platforms_map=$(jq --arg p "$p" --arg lfn "$lfn" '.[$p].lfn = $lfn' <<< "$platforms_map")
          done

          # Convert mapping to array of objects: [{arch: "amd64", sfn: "...", lfn: "..."}, ...]
          platforms_array=$(jq -c 'to_entries | map({arch:.key} + .value)' <<< "$platforms_map")

          echo "$platforms_array"
          echo "platforms=$platforms_array" >> $GITHUB_OUTPUT

      - name: Upload build artifacts
        uses: actions/upload-artifact@v5
        id: upload-artifacts
        if: always()
        with:
          name: snap-build-artifacts
          path: |
            zwave-js-ui*.snap
            snapcraft-*.txt
          retention-days: 7

      - name: Uploaded URLs
        run: |
          echo "${{ steps.upload.outputs }}" | yq '.' -oj
        

  upload:
    needs: build 
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: ${{ fromJson(needs.build.outputs.platforms) }}
      fail-fast: true
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v6
        with:
          name: snap-build-artifacts
          path: .

      - name: For build platform ${{ matrix.platform.arch }}
        id: file
        run: |
          set -euo pipefail
          arch="${{ matrix.platform.arch }}"
          
          # Find files for this architecture in the downloaded artifacts
          sfn=$(ls -1 zwave-js-ui*_"${arch}".snap 2>/dev/null | head -1 || echo "")
          lfn=$(ls -1 snapcraft-*_"${arch}"_*.txt 2>/dev/null | head -1 || echo "")
          
          echo "Found snap file: ${sfn}"
          echo "Found log file: ${lfn}"
          
          echo "paths<<EOF" >> "$GITHUB_OUTPUT"
          if [[ -n "$sfn" ]]; then
            echo "${sfn}" >> "$GITHUB_OUTPUT"
          fi
          if [[ -n "$lfn" ]]; then
            echo "${lfn}" >> "$GITHUB_OUTPUT"
          fi
          echo "EOF" >> "$GITHUB_OUTPUT"
      - name: Outputs from ${{ matrix.platform.arch }}
        run: |
          echo "${{ steps.file.outputs.paths }}"

      - name: Upload ${{ matrix.platform.arch }}
        uses: actions/upload-artifact@v5
        id: upload
        if: ${{ steps.file.outputs.paths != '' }} 
        with:
          name: ${{ matrix.platform.arch }}
          path: ${{ steps.file.outputs.paths }}
        



          
