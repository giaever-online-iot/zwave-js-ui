name: PR Build Snap

on:
  pull_request:
    branches:
      - main
  workflow_run:
    branches:
      - main
    workflows: 
      - "Block non-conforming PRs (auto-close + label)"
    types:
      - completed
  workflow_dispatch:  # Add this for manual testing

permissions:
  contents: read
  actions: read
  pull-requests: read

jobs:
  build:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run == null || github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: read
      actions: write
    outputs:
      platforms: ${{ steps.build.outputs.platforms }}
      artifacts-url: ${{ steps.upload-artifacts.outputs.archive_download_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.event.pull_request.head.sha || github.ref }}
          fetch-depth: 0

      - name: Extract platforms from snapcraft.yaml
        id: extract
        run: |
          # Output a compact JSON array of platform keys, e.g. ["amd64","arm64"]
          # archs=$(yq '.platforms | keys' -oj -I0 snap/snapcraft.yaml) 
          printf 'platforms=%s\n' "$(echo "${archs:-"['amd64']"}" | yq '.' -oj -I0)" >> "$GITHUB_OUTPUT"

      - name: Build for ${{ steps.extract.outputs.platforms }}
        id: build
        run: |
          set -xuo pipefail

          # Read platforms JSON array from previous step
          platforms="$(echo "${{ steps.extract.outputs.platforms }}" | yq '.' -oj -I0)"

          sudo snap install snapcraft --classic
          export SNAPCRAFT_STORE_CREDENTIALS="${{ secrets.SNAPCRAFT_STORE_CREDENTIALS }}"
          snapcraft whoami || true
          mkdir -p ~/.local/share/snapcraft
          echo "${{ secrets.LAUNCHPAD_CREDENTIALS }}" > ~/.local/share/snapcraft/launchpad-credentials

          # Build for comma-separated list of arches
          snapcraft remote-build -v --launchpad-accept-public-upload \
            --build-for=$(yq '. | join(",")' <<< "$platforms")

          # Safely write the platforms step output (avoid nested-quote issues)
          printf 'platforms=%s\n' "$(echo "$platforms" | yq '.' -oj -I0)" >> "$GITHUB_OUTPUT"

      - name: Normalize .snap/.txt artifact names
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          shopt -s globstar nullglob || true

          # install yq if missing
          if ! command -v yq >/dev/null 2>&1; then
            echo "Installing yq..."
            sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
            sudo chmod +x /usr/local/bin/yq
          fi

          name=$(yq -r '.name' snap/snapcraft.yaml)
          version=$(yq -r '.version' snap/snapcraft.yaml)
          echo "snap name=${name}, version=${version}"

          files=(**/*.{snap,txt})
          if [ ${#files[@]} -eq 0 ]; then
            echo "No .snap or .txt files found"
            exit 0
          fi

          for f in "${files[@]}"; do
            base=$(basename -- "$f")
            dir=$(dirname -- "$f")
            ext=${base##*.}
            if [ "${ext}" = "txt" ]; then
              # txt: expect ..._<platform>_TIMESTAMP.txt
              platform=$(echo "$base" | sed -E 's/.*_([A-Za-z0-9-]+)_[0-9T:._-]+\.txt$/\1/')
              newext=log
            else
              # snap: expect ..._<platform>.snap
              platform=$(echo "$base" | sed -E 's/.*_([A-Za-z0-9-]+)\.snap$/\1/')
              newext=snap
            fi
            if [ -z "$platform" ] || [ "$platform" = "$base" ]; then
              echo "Could not detect platform for '$f', skipping"
              continue
            fi
            newbase="${name}_${version}_${platform}"
            candidate="${dir}/${newbase}.${newext}"
            i=0
            while [ -e "$candidate" ]; do
              i=$((i+1))
              candidate="${dir}/${newbase}_${i}.${newext}"
            done
            echo "Renaming '$f' -> '$candidate'"
            mv -v -- "$f" "$candidate"
          done

      - name: Upload build artifacts
        uses: actions/upload-artifact@v5
        id: upload-artifacts
        if: always()
        with:
          name: snap-build-artifacts
          path: |
            zwave-js-ui*.snap
            zwave-js-ui*.log
          retention-days: 7
          
      - name: Uploaded artifacts URL
        run: |
          echo "Upload action outputs: ${{ toJson(steps.upload-artifacts.outputs) }}"
          echo "Archive download URL: ${{ steps.upload-artifacts.outputs.archive_download_url }}"

  upload:
    needs: build 
    runs-on: ubuntu-latest
    permissions:
      actions: write
    strategy:
      matrix:
        platform: ${{ fromJson(needs.build.outputs.platforms) }}
      fail-fast: true
    steps:
      - name: Download build artifacts ${{ matrix.platform }}
        uses: actions/download-artifact@v6
        id: download-artifacts
        with:
          name: snap-build-artifacts
          path: .

      - name: "For logging URLs: ${{ matrix.platform }}"
        run: |
          echo "${{ toJson(steps.download-artifacts.outputs) }}"
          echo "Files in workspace (downloaded artifact contents):"
          ls -la
          echo "Artifact archive URL from build job: ${{ needs.build.outputs.artifacts-url }}"

