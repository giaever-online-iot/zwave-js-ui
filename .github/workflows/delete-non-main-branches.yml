---
name: Delete all branches except main

'on':
  workflow_dispatch:  # Manual trigger only for safety
    inputs:
      protected_branch:
        description: 'Branch to keep (default: main)'
        required: false
        default: 'main'

permissions:
  contents: write

jobs:
  delete-branches:
    runs-on: ubuntu-latest
    steps:
      - name: Delete all branches except protected branch
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const protectedBranch =
              '${{ inputs.protected_branch }}' || 'main';

            core.info(
              `Protected branch: ${protectedBranch}`
            );

            // Get all branches with pagination
            const branches = await github.paginate(
              github.rest.repos.listBranches,
              {
                owner,
                repo,
                per_page: 100
              }
            );

            core.info(`Found ${branches.length} branches total`);

            // Filter out protected branch
            const branchesToDelete = branches.filter(
              branch => branch.name !== protectedBranch
            );

            core.info(
              `Will delete ${branchesToDelete.length} branches`
            );

            let successCount = 0;
            let failCount = 0;

            // Delete each branch
            // Note: Protected branches cannot be deleted via API
            for (const branch of branchesToDelete) {
              try {
                core.info(`Deleting branch: ${branch.name}`);
                await github.rest.git.deleteRef({
                  owner,
                  repo,
                  ref: `heads/${branch.name}`
                });
                core.info(
                  `✓ Successfully deleted: ${branch.name}`
                );
                successCount++;
              } catch (error) {
                core.warning(
                  `✗ Failed to delete ${branch.name}: ${error.message}`
                );
                failCount++;
              }
            }

            core.info(
              `Deletion complete! Success: ${successCount}, ` +
              `Failed: ${failCount}`
            );
